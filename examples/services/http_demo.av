module HttpDemo
    intent:
        "Demonstrates the built-in Http service: GET, POST, and response handling."
        "Http is a platform capability — declared with ! [Http], enforced statically."

record Header
    name: String
    value: String

decision HttpAsCapability:
    date: "2025-01-01"
    reason:
        "HTTP access is a side effect like any other. Declaring ! [Http] makes"
        "it visible in the signature — callers know the function goes outside the process."
        "4xx/5xx are Ok(response) because they are valid HTTP exchanges;"
        "only transport failures (timeout, DNS, refused) are Err."
    chosen: BuiltinService
    rejected: [NetworkDotAv, ImplicitIO]
    impacts: [fetch, checkStatus, post]

fn fetch(url: String) -> Result<HttpResponse, String>
    ? "GET a URL. Returns Ok(HttpResponse) on any HTTP reply, Err on transport failure."
    ! [Http]
    Http.get(url)

fn checkStatus(url: String) -> Result<Int, String>
    ? "Returns Ok(status code as Int) or Err(transport error)."
    ! [Http]
    val result = Http.get(url)
    match result:
        Result.Ok(resp) -> Result.Ok(resp.status)
        Result.Err(msg) -> Result.Err(msg)

fn post(url: String, payload: String, token: String) -> Result<HttpResponse, String>
    ? "POST JSON with a Bearer token. Builds the Authorization header explicitly."
    ! [Http]
    val auth = Header(name: "Authorization", value: "Bearer {token}")
    Http.post(url, payload, "application/json", [auth])

fn main() -> Unit
    ! [Http, Console]
    val url = "https://httpbin.org/get"

    val r1 = fetch(url)
    match r1:
        Result.Ok(resp) -> Console.print("GET {url} — status: {resp.status}, body length: {String.length(resp.body)}")
        Result.Err(msg) -> Console.print("Transport error: {msg}")

    val r2 = checkStatus("https://httpbin.org/status/404")
    match r2:
        Result.Ok(status) -> Console.print("404 endpoint returned status: {status}")
        Result.Err(msg)   -> Console.print("Transport error: {msg}")

    val r3 = post("https://httpbin.org/post", "{{}}", "demo-token")
    match r3:
        Result.Ok(resp) -> Console.print("POST status: {resp.status}")
        Result.Err(msg) -> Console.print("POST failed: {msg}")
